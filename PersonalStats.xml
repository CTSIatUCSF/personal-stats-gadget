<?xml version="1.0" encoding="UTF-8"?>
<Module>
	<ModulePrefs title="Personal Stats" author="Dan Hoffman">
		<OAuth2>
		  <Service name="googleAPIv3" scope="https://www.googleapis.com/auth/analytics.readonly">
		  </Service>
		</OAuth2>
		<Require feature="views"/>
		<Require feature="settitle"/>
		<Require feature="osapi"/>
		<!-- Require feature="minimessage" /-->
		<!-- Require feature="dynamic-height" /-->
		<Require feature="orng"/>
		<Require feature="jsonld"/>
		<!-- Require feature="start-hidden" /-->
		<Require feature="setprefs" />
	</ModulePrefs>
	<Content type="html" view="canvas, small"><![CDATA[<!--HTML-->
    <!DOCTYPE html>
    
        <!-- #includes -->
        <link rel="stylesheet" href="css/gadget.css" type="text/css" media="screen, projection" >
        <link rel="stylesheet" href="css/inst.css" type="text/css" media="screen, projection" >
        <link rel="stylesheet" href="css/jquery-ui.min.css" type="text/css" media="screen, projection" >
	    <script type="text/javascript" src="js/os.js" ></script>
	    <script type="text/javascript" src="js/ontology.js" ></script>
        <script type="text/javascript" src="js/jquery-1.11.1.min.js"></script>
        <script type="text/javascript" src="js/jquery-ui.min.js"></script>
        <script type="text/javascript" src="js/jsonld.js" ></script>
        <script type="text/javascript" src="js/environment.js"></script>
                
        <style>
            .tool_title {font-size:14px;}
            .tool_title_orange {font-weight:bold; font-size:14px; color:#CA7C29;margin-top:-1px;}
            .tool_body {font-size:12px;}
            .tool_credit {font-size:10px;}
            .tool_table_cell {ffont-size:12px; padding:0 20px 0 0;}
            .tool_table_cell_small {font-size:11px;}
            .tool_table_cell_small span a {font-size:11px;}
            .tool_table_cell_small span {font-size:11px;display:inline-block;margin-right: -15px; }
            .tool_toggle_button {font-size: 13px;padding:0 5px;}          
    	</style>

        <script type="text/javascript">
        </script>]]>
	</Content>
	<Content type="html" view="small" preferred_height="75" preferred_width="190"><![CDATA[<!--HTML-->
    <!DOCTYPE html>
 
 		<table id="button_and_help" cellspacing="2" cellpadding="0" style="display:block;">
 				<tr>
 						<td class="tool_table_cell_small" style="width:160px;padding:4px 0">
							<a id="linkToCanvas"href=linkClicked()>Click here for canvas view.</a>
						</td>
 				</tr>
 		</table>
        
        <img id="waiting" src="images/waiting.gif" style="display:none;">
        
        <script type="text/javascript">

	            function init() {
					$('#linkToCanvas').click(function(){ 
						linkToCanvasClicked();
						return false;
					});
	            }
				
				function linkToCanvasClicked() {
					var my_params = {
  						foo : 12345,
						bar : "Bar value"
					};
					var canvas_view = new gadgets.views.View("canvas");
					gadgets.views.requestNavigateTo(canvas_view, my_params);
				}
			
                gadgets.util.registerOnLoadHandler(init);
        </script>]]></Content>
	<Content type="html" view="canvas" preferred_height="620" preferred_width="940"><![CDATA[<!--HTML-->
    <!DOCTYPE html>
           <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
           <script type="text/javascript" src="js/jquery.blockUI-2.66.0.js"></script>    
           

        <style>
        	#main {
               	margin: 0px;
               	padding: 0px;
               	font-size: small;
           	}
        </style>
    
        <div id="main" style="display: none">
        </div>

        <div id="approval" style="display: none">
          <a href="#" id="personalize">Personalize this gadget</a>
          <ol>
            <b><u>In order to use this Demo Gadget you must</u></b> 
            <li>Have or create a Google account and know your userid and password</li>
            <li>Register a new application at <a href="https://code.google.com/apis/console">https://code.google.com/apis/console</a></li>
            <li>Make sure your app's "Redirect URIs" applies to your shindig environment (e.g. http://localhost:8080/gadgets/oauth2callback)</li>
            <li>Update the Google client "Client ID" and "Client Secret" in the OAuth2 persistence (default is <code>config/oauth2.json</code>)</li>
            <li>Restart the server</li>
            <li>Click the link above to initiate the authorization process</li>
          </ol>    
         
        </div>

        <div id="waiting" style="display: none">
          Please click
          <a href="#" id="approvaldone">I've approved access</a>
          once you've approved access to your data.
        </div>

        <div id="error" style="display: none;background-color:yellow;font-size:xx-small;" title="An error occured processing your request">
           <div id="error_code"><u>code:</u></div>
           <div id="error_uri"><u>uri:</u></div>
           <div id="error_description"><u>description:</u></div>
           <div id="error_explanation"><u>explanation:</u></div>
           <div id="error_trace"><u>trace:</u></div>
        </div>

		<!-- Include libraries for getting Auth token using JWS -->
		<script type="text/javascript" src="http://kjur.github.io/jsrsasign/jsrsasign-latest-all-min.js"></script>
		<script type="text/javascript" src="js/json-sans-eval-min.js"></script>
		<script type="text/javascript" src="js/jws-3.2.min.js"></script>
	
		<!--Load the AJAX API-->
		<script type="text/javascript" src="https://www.google.com/jsapi"></script>
	
		<!--Load the Google JS Client-->
		<script type="text/javascript" src="https://apis.google.com/js/client.js?onload=handleClientLoad"></script>
	
		<!-- Load Google Analytics Embed API Library -->
		<script>
			(function(w,d,s,g,js,fs){
			  g=w.gapi||(w.gapi={});g.analytics={q:[],ready:function(f){this.q.push(f);}};
			  js=d.createElement(s);fs=d.getElementsByTagName(s)[0];
			  js.src='https://apis.google.com/js/platform.js';
			  fs.parentNode.insertBefore(js,fs);js.onload=function(){g.load('analytics');};
			}(window,document,'script'));
		</script>
	
		  <script type="text/javascript">
		    function getElement(x) {
		      return document.getElementById(x);
		    }

		    function showOneSection(toshow) {
		      var sections = [ 'main', 'approval', 'waiting', 'error' ];
		      for (var i=0; i < sections.length; ++i) {
		        var s = sections[i];
		        var el = getElement(s);
		        if (s === toshow) {
		          el.style.display = "block";
		        } else {
		          el.style.display = "none";
		        }
		      }
		    }

		    function fetchData() {
		      url = "https://www.googleapis.com/analytics/v3/data/ga?ids=ga:23439892&start-date=2015-01-01&end-date=2015-01-31&metrics=ga:sessions,ga:bounces";
		      var params = {};		
		      params[gadgets.io.RequestParameters.CONTENT_TYPE] =
		        gadgets.io.ContentType.TEXT;
		      params[gadgets.io.RequestParameters.AUTHORIZATION] =
		        gadgets.io.AuthorizationType.OAUTH2;
		      params[gadgets.io.RequestParameters.METHOD] =
		        gadgets.io.MethodType.GET;
		      params[gadgets.io.RequestParameters.OAUTH_SERVICE_NAME] = "googleAPIv3";
		      params[gadgets.io.RequestParameters.REFRESH_INTERVAL] = "0";

		      gadgets.io.makeRequest(url, function (response) {
		        if (response.oauthApprovalUrl) {
		          var onOpen = function() {
		            showOneSection('waiting');
		          };
		          var onClose = function() {
		            fetchData();
		          };
		          var popup = new gadgets.oauth.Popup(response.oauthApprovalUrl,
		              null, onOpen, onClose);
		          getElement('personalize').onclick = popup.createOpenerOnClick();
		          getElement('approvaldone').onclick = popup.createApprovedOnClick();
		          showOneSection('approval');
		        } else if (response.data) {
		          getElement('main').appendChild(document.createTextNode(response.data));
		          showOneSection('main');
		        } else {
		           getElement('error_code').appendChild(document.createTextNode(response.oauthError));
		           getElement('error_uri').appendChild(document.createTextNode(response.oauthErrorUri));
		           getElement('error_description').appendChild(document.createTextNode(response.oauthErrorText));
		           getElement('error_explanation').appendChild(document.createTextNode(response.oauthErrorExplanation));
		           getElement('error_trace').appendChild(document.createTextNode(response.oauthErrorTrace));
		          showOneSection('error');
		        }
		      }, params);
		    }

		    gadgets.util.registerOnLoadHandler(fetchData);
		  </script>
		      ]]>
		</Content>
</Module>