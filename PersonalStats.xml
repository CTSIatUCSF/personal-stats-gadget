<?xml version="1.0" encoding="UTF-8"?>
<Module>
	<ModulePrefs title="Personal Stats" author="Dan Hoffman">
		<OAuth2>
		  <Service name="googleAPIv3" scope="https://www.googleapis.com/auth/analytics.readonly">
		  </Service>
		</OAuth2>
		<Require feature="views"/>
		<Require feature="settitle"/>
		<Require feature="osapi"/>
		<!-- Require feature="minimessage" /-->
		<!-- Require feature="dynamic-height" /-->
		<Require feature="orng"/>
		<Require feature="jsonld"/>
		<!-- Require feature="start-hidden" /-->
		<Require feature="setprefs" />
	</ModulePrefs>
	<Content type="html" view="canvas, small"><![CDATA[<!--HTML-->
    <!DOCTYPE html>
    
        <!-- #includes -->
        <link rel="stylesheet" href="css/gadget.css" type="text/css" media="screen, projection" >
        <link rel="stylesheet" href="css/inst.css" type="text/css" media="screen, projection" >
        <link rel="stylesheet" href="css/jquery-ui.min.css" type="text/css" media="screen, projection" >
	    <script type="text/javascript" src="js/os.js" ></script>
	    <script type="text/javascript" src="js/ontology.js" ></script>
        <script type="text/javascript" src="js/jquery-1.11.1.min.js"></script>
        <script type="text/javascript" src="js/jquery-ui.min.js"></script>
        <script type="text/javascript" src="js/jsonld.js" ></script>
        <script type="text/javascript" src="js/environment.js"></script>
                
        <style>
            .tool_title {font-size:14px;}
            .tool_title_orange {font-weight:bold; font-size:14px; color:#CA7C29;margin-top:-1px;}
            .tool_body {font-size:12px;}
            .tool_credit {font-size:10px;}
            .tool_table_cell {ffont-size:12px; padding:0 20px 0 0;}
            .tool_table_cell_small {font-size:11px;}
            .tool_table_cell_small span a {font-size:11px;}
            .tool_table_cell_small span {font-size:11px;display:inline-block;margin-right: -15px; }
            .tool_toggle_button {font-size: 13px;padding:0 5px;}          
    	</style>

        <script type="text/javascript">
        	
        	Date.prototype.yyyy_mm_dd = function() {
        		var yyyy = this.getFullYear().toString();
        	    var mm = (this.getMonth()+1).toString(); // getMonth() is zero-based
        	    var dd  = this.getDate().toString();
        	    return yyyy + "-" + (mm[1]?mm:"0"+mm[0]) + "-" + (dd.length===2?dd:"0"+dd[0]); // padding
        	};

        	Date.prototype.yyyymmdd = function() {
        		var yyyy = this.getFullYear().toString();
        	    var mm = (this.getMonth()+1).toString(); // getMonth() is zero-based
        	    var dd  = this.getDate().toString();
        	    return yyyy + (mm[1]?mm:"0"+mm[0]) + (dd.length===2?dd:"0"+dd[0]); // padding
        	};
        </script>]]>
	</Content>
	<Content type="html" view="small" preferred_height="75" preferred_width="190"><![CDATA[<!--HTML-->
    <!DOCTYPE html>
 
 		<table id="button_and_help" cellspacing="2" cellpadding="0" style="display:block;">
 				<tr>
 						<td class="tool_table_cell_small" style="width:160px;padding:4px 0">
							<a id="linkToCanvas"href=linkClicked()>Click here for canvas view.</a>
						</td>
 				</tr>
 		</table>
        
        <img id="waiting" src="images/waiting.gif" style="display:none;">
        
        <script type="text/javascript">
        	var ownerURI;

            function init() {

				osapi.jsonld.getOwner().execute(function(ownerData) {
					ownerURI = ownerData.uris[0];

					//don't enable the link until we have the owner data
					$('#linkToCanvas').click(function(){ 
						linkToCanvasClicked();
						return false;
					});
				});
            }
			
			function linkToCanvasClicked() {
		    	gadgets.views.requestNavigateTo("canvas", {}, ownerURI);
			}
		
            gadgets.util.registerOnLoadHandler(init);
        </script>]]></Content>
	<Content type="html" view="canvas" preferred_height="1000" preferred_width="940"><![CDATA[<!--HTML-->
    <!DOCTYPE html>
           <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
           <script type="text/javascript" src="js/jquery.blockUI-2.66.0.js"></script>    
           <style type="text/css" src="css/personal-stats.css"></style>
    
        <div class="gadget-content">
    		<div id="view_count_last_year" class="stats-title">This is the Personal Stats Gadget's canvas page.</div>
    		
			<div id="chart_container" class="stats-chart"></div>

			<table id="view_count_table" class="stats-table">
				<tr>
					<td class="stats-table-item">
						<div class="stats-text">So far this month</div>
						<div id="view_count_this_month" class="stats-text-large"></div>
						<div class="stats-text">Visitors</div>
					</td>
					<td class="stats-table-item-center">
						<div class="stats-text">Best Month Ever</div>
						<div id="view_count_best_month" class="stats-text-large"></div>
						<div class="stats-text">Visitors</div>
					</td>
					<td class="stats-table-item">
						<div id="view_count_all_time_since" class="stats-text"></div>
						<div id="view_count_all_time" class="stats-text-large"></div>
						<div class="stats-text">Visitors</div>
						<div class="stats-text-small">* First month data is available for your profile page</div>
					</td>
				</tr>
			</table>
			<div id="geo-panel" class="panel">
				<div class="panel-title">Views By Country</div>
				<div class="panel-button-area">
					<div id="geo-toggle" class="toggle-btn-grp joint-toggle">
					    <label onclick="" class="toggle-btn"><input type="radio" name="countryToggle"/>Last 30 Days</label><label onclick="" class="toggle-btn"><input type="radio" name="countryToggle"/>Last Year</label>
					</div>
				</div>
				<div class="panel-data-area">
					<div id="geo-list-area">
						<table id="geo-list" class="panel-list"></table>
						<label id="geo-see-all-btn" class="toggle-btn toggle-btn-grp geo-list-btn visuallyhidden">See All</label>
						<label id="geo-see-fewer-btn" class="toggle-btn toggle-btn-grp geo-list-btn visuallyhidden">See Fewer</label>
					</div>
					<div id="geo-chart"></div>
				</div>
			</div>
			<div id="domain-panel" class="panel">
				<div class="panel-title">Views By Company/Domain</div>
				<div class="panel-button-area">
					<div id="domain-toggle" class="toggle-btn-grp joint-toggle">
					    <label onclick="" class="toggle-btn"><input type="radio" name="domainToggle"/>Last 30 Days</label><label onclick="" class="toggle-btn"><input type="radio" name="domainToggle"/>Last Year</label>
					</div>
				</div>
				<div class="panel-data-area">
					<div id="domain-list-area">
						<table id="domain-list" class="panel-list"></table>
						<label id="domain-see-all-btn" class="toggle-btn toggle-btn-grp geo-list-btn visuallyhidden">See All</label>
						<label id="domain-see-fewer-btn" class="toggle-btn toggle-btn-grp geo-list-btn visuallyhidden">See Fewer</label>
					</div>
					<div id="geo-chart"></div>
				</div>
			</div>
	    </div>
	
		<!--Load the Google AJAX API-->
		<script type="text/javascript" src="https://www.google.com/jsapi"></script>
	
		<script language="JavaScript" type="text/javascript">

			var ownerData, aggregatedByMonthAll, aggregatedByMonthLastYear, aggregatedByCountryLastYear, aggregatedByCountryLastMonth, countryCodeList, aggregatedByDomainLastYear, aggregatedByDomainLastMonth;
			var onlyShow = 10;

	        // Load the Visualization API and the column chart package.
	        google.load("visualization", "1.0", {"packages":["corechart", "geochart"]});

	        // Set up the toggle buttons
	        $(".toggle-btn input[type=radio]").addClass("visuallyhidden");
	        $(".toggle-btn input[type=radio]").change(function() {
	            if( $(this).attr("name")) {
	                $(this).parent().addClass("success").siblings().removeClass("success")
	            } else {
	                $(this).parent().toggleClass("success");
	            }
	        });

	        $("#geo-toggle .toggle-btn input[type=radio]").first().click(function() {
	        	console.log("country-month selected");
	            showViewsByCountry(aggregatedByCountryLastMonth, onlyShow);
	            drawGeoChart(aggregatedByCountryLastMonth);
	        });

	        $("#geo-toggle .toggle-btn input[type=radio]").last().click(function() {
	            console.log("country-year selected");
	            showViewsByCountry(aggregatedByCountryLastYear, onlyShow);
	            drawGeoChart(aggregatedByCountryLastYear);
	        });
	        $("#domain-toggle .toggle-btn input[type=radio]").first().click(function() {
	        	console.log("domain-month selected");
	            showViewsByDomain(aggregatedByDomainLastMonth, onlyShow);
	        });

	        $("#domain-toggle .toggle-btn input[type=radio]").last().click(function() {
	            console.log("domain-year selected");
	            showViewsByDomain(aggregatedByDomainLastYear, onlyShow);
	        });

	        // Turn on the first toggle button for each panel
	        $("#geo-toggle .toggle-btn input[type=radio]").first().parent().addClass("success");
	        $("#domain-toggle .toggle-btn input[type=radio]").first().parent().addClass("success");



	        // See All (geo) button shows all for Month or Year (based on current selection)
	        $("#geo-see-all-btn").click(function() {
	        	console.log("see all button clicked");
	        	
	        	if ($("#geo-toggle .toggle-btn input[type=radio]").first().parent().hasClass("success")) {
		        	console.log("see all button clicked - last month");
		            showViewsByCountry(aggregatedByCountryLastMonth);
	        	} else {
		        	console.log("see all button clicked - last year");
		            showViewsByCountry(aggregatedByCountryLastYear);
	        	}
  				// hide the See All button 
				$("#geo-see-all-btn").each(function() {
  					$(this).addClass("visuallyhidden");
  				});
  				// unhide the See Fewer button 
				$("#geo-see-fewer-btn").each(function() {
  					$(this).removeClass("visuallyhidden");
  				});
	        });

	        // See Fewer (geo) button shows fewer results for Month or Year (based on current selection)
	        $("#geo-see-fewer-btn").click(function() {
	        	console.log("see fewer button clicked");
	        	
	        	if ($("geo-toggle .toggle-btn input[type=radio]").first().parent().hasClass("success")) {
		        	console.log("see fewer button clicked - last month");
		            showViewsByCountry(aggregatedByCountryLastMonth, onlyShow);
	        	} else {
		        	console.log("see fewer button clicked - last year");
		            showViewsByCountry(aggregatedByCountryLastYear, onlyShow);
	        	}
  				// hide the See Fewer button 
				$("#geo-see-fewer-btn").each(function() {
  					$(this).addClass("visuallyhidden");
  				});
  				// unhide the See All button 
				$("#geo-see-all-btn").each(function() {
  					$(this).removeClass("visuallyhidden");
  				});
	        });

	        // See All (domain) button shows all for Month or Year (based on current selection)
	        $("#domain-see-all-btn").click(function() {
	        	console.log("see all button clicked");
	        	
	        	if ($("domain-toggle .toggle-btn input[type=radio]").first().parent().hasClass("success")) {
		        	console.log("see all button clicked - last month");
		            showViewsByDomain(aggregatedByDomainLastMonth);
	        	} else {
		        	console.log("see all button clicked - last year");
		            showViewsByDomain(aggregatedByDomainLastYear);
	        	}
  				// hide the See All button 
				$("#domain-see-all-btn").each(function() {
  					$(this).addClass("visuallyhidden");
  				});
  				// unhide the See Fewer button 
				$("#domain-see-fewer-btn").each(function() {
  					$(this).removeClass("visuallyhidden");
  				});
	        });

	        // See Fewer (domain) button shows fewer results for Month or Year (based on current selection)
	        $("#domain-see-fewer-btn").click(function() {
	        	console.log("see fewer button clicked");
	        	
	        	if ($("domain-toggle .toggle-btn input[type=radio]").first().parent().hasClass("success")) {
		        	console.log("see fewer button clicked - last month");
		            showViewsByDomain(aggregatedByDomainLastMonth, onlyShow);
	        	} else {
		        	console.log("see fewer button clicked - last year");
		            showViewsByDomain(aggregatedByDomainLastYear, onlyShow);
	        	}
  				// hide the See Fewer button 
				$("#domain-see-fewer-btn").each(function() {
  					$(this).addClass("visuallyhidden");
  				});
  				// unhide the See All button 
				$("#domain-see-all-btn").each(function() {
  					$(this).removeClass("visuallyhidden");
  				});
	        });
	  
		  	function fetchData() {

				var ownerHomePage = ownerData[FOAF("workplaceHomepage")];

				var ownerUrlParts = ownerHomePage.split("/");
				var ownerId = ownerUrlParts[ownerUrlParts.length-1];
				var pagePath = encodeURIComponent("=~/" + ownerId);

				var earliest_start_date = "2009-12-01"
				var today = new Date().yyyy_mm_dd();

				var query = {
					'ids': 'ga:23439892',
			    	'metrics': 'ga:sessions',
			        'dimensions': 'ga:date,ga:country,ga:networkDomain',
					'filters': 'ga:pagePath' + pagePath,
			        'start-date': earliest_start_date,
			        'end-date': today
			    }

				var query_string = "";
				for (var key in query) {
				   if (query.hasOwnProperty(key)) {
				      query_string = query_string + key + "=" + query[key] + "&"; 
				   }
				}
				query_string = query_string.slice(0,-1); // remove the "&" at the end of query_string

		        url = "https://www.googleapis.com/analytics/v3/data/ga?" + query_string;
		        
		        var params = {};		
		        params[gadgets.io.RequestParameters.CONTENT_TYPE] =
		          	gadgets.io.ContentType.TEXT;
		        params[gadgets.io.RequestParameters.AUTHORIZATION] =
		          	gadgets.io.AuthorizationType.OAUTH2;
		        params[gadgets.io.RequestParameters.METHOD] =
		          	gadgets.io.MethodType.GET;
		        params[gadgets.io.RequestParameters.OAUTH_SERVICE_NAME] = "googleAPIv3";
		        params[gadgets.io.RequestParameters.REFRESH_INTERVAL] = "0";

		        gadgets.io.makeRequest(url, function (response) {
		        	console.log("response via oauth2")
		        	console.log(response);
		          	if (response.oauthApprovalUrl) {
		        		console.log("OAuth Approval URL:")
		        		console.log(response.oauthApprovalUrl);
		            
		          	} else if (response.data) {
						var data = JSON.parse(response.data);
		      		 	aggregatedByMonthAll = aggregateDataByMonth(data.rows);
				 		aggregatedByMonthLastYear = aggregateDataByMonth(data.rows, getYearMonthOneYearAgoMonthStart());
				 		aggregatedByCountryLastYear = aggregateDataByCountry(data.rows, dateOneYearAgo().yyyymmdd());
				 		aggregatedByCountryLastMonth = aggregateDataByCountry(data.rows, dateThirtyDaysAgo().yyyymmdd());
				 		aggregatedByDomainLastYear = aggregateDataByDomain(data.rows, dateOneYearAgo().yyyymmdd());
		      			console.log("aggregatedByDomainLastYear");
		      			console.log(aggregatedByDomainLastYear);
		      			console.log(dateThirtyDaysAgo());
				 		aggregatedByDomainLastMonth = aggregateDataByDomain(data.rows, dateThirtyDaysAgo().yyyymmdd());
		      			console.log("aggregatedByDomainLastMonth");
		      			console.log(aggregatedByDomainLastMonth);

		      			showVisitorCountStats();
						drawColumnChart(aggregatedByMonthLastYear);

		      			showViewsByCountry(aggregatedByCountryLastMonth, 10);
		      			drawGeoChart(aggregatedByCountryLastMonth);

		      			showViewsByDomain(aggregatedByDomainLastMonth, 10);

		          	} else {
			      		console.log("Error:")
			      		console.log(response.data);
			      		console.log(response.oauthError);
			      		console.log(response.oauthErrorUri);
			      		console.log(response.oauthErrorText);
			      		console.log(response.oauthErrorExplanation);
			      		console.log(response.oauthErrorTrace);
		          	}
		        }, params);
	    	}
	    			
			// Format Google Analytics yearMonth string (ex: 201506) as Mmm-YYYY (ex: Jun-2015)
			function formatMonthYear(yearMonthString) {
			  	var months = new Array('Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'); 
				var year, month_number, month;
			
				year = yearMonthString.substring(2, 4);
				month_number = yearMonthString.substring(4, 6) - 1;
				month = months[month_number];
				new_value = month + "-" + year;
				return new_value;
			}

	    	function dateOneYearAgo() {
				var today = new Date();
			 	var oneYearAgo = new Date(today.getFullYear() - 1, today.getMonth(), today.getDay());
			 	return oneYearAgo;
	    	}

	    	function dateThirtyDaysAgo() {
				var today = new Date();
				var thirtyDaysAgo = new Date(today.setDate(today.getDate()-30));
			 	return thirtyDaysAgo;
	    	}

		    function drawColumnChart(data) {
				console.log("drawColumnChart called")
			
		        // Create the data table.
		        var data_table = new google.visualization.DataTable();
		        data_table.addColumn('string', 'Month');
		        data_table.addColumn('number', 'Sessions');
			    data_table.addColumn({type: 'string', role: 'style'});
				populateDataTable_ColumnChart(data_table, data);

		        // Set chart options
		        var options = {
					legend: {position: 'none'}
			    };

		        // Instantiate and draw our chart, passing in some options.
		        var chart = new google.visualization.ColumnChart(document.getElementById('chart_container'));
		        chart.draw(data_table, options);
	      	}

		    function drawGeoChart(data) {
				console.log("drawGeoChart called")
			
		        // Create the data table.
		        var data_table = new google.visualization.DataTable();
		        data_table.addColumn('string', 'Country');
		        data_table.addColumn('number', 'Sessions');
				populateDataTable_GeoChart(data_table, data);

        		var options = {
		            colorAxis: {colors: ["#FFCC00", "#FF0000"]},
        		};
        		var chart = new google.visualization.GeoChart(document.getElementById("geo-chart"));
		        chart.draw(data_table, options);
	      	}

	      	function aggregateDataByMonth(data, yearMonthStart) {

	      		var start = yearMonthStart || 0;
	      		var lastItemIndex = data.length-1; 
	      		var lastIndex = data[0].length-1;

				var monthArray = data.map(function(elem) {
				    return elem[0].slice(0, -2);
				});

				var filteredMonthArray = monthArray.filter(function(elem, i, array) {
				        return array.indexOf(elem) === i && elem >= start;
				    }
				);

				var arrayToReturn = filteredMonthArray.map(function(month) {
				    var count = data.reduce(function(prevVal, elem) {
				        if(elem[0].slice(0, -2) == month) {
				            return prevVal + parseInt(elem[lastIndex]);
				        } 
				        else {
				            return prevVal;
				        }
				    }, 0);
				    return new Array(month, count); 
				});

				// add a row for the current month if one doesn't exist
				var today = new Date();
				var thisYearMonth = convertDateToYearMonthString(today);

				var lastItem = data[lastItemIndex];
				if (lastItem[0].slice(0, -2) != thisYearMonth) {
					var rowToAdd = new Array(thisYearMonth, 0);
					arrayToReturn.push(rowToAdd);
				}

				return arrayToReturn;
	      	}

	      	function populateDataTable_ColumnChart(dataTable, dataToAdd) {
				for (idx in dataToAdd) {
					row = dataToAdd[idx];
					lastIndex = row.length-1;
					dataTableRow = new Array();
					dataTableRow[0] = formatMonthYear(row[0]);
					dataTableRow[1] = row[lastIndex];
					dataTableRow[2] = "color: #CA7C29";
					dataTable.addRow(dataTableRow);
				}
				// remove the last row, which contains data for this month (we show this data elsewhere)
				var lastItemIndex = dataTable.getNumberOfRows()-1;
				dataTable.removeRow(lastItemIndex);
			}

	      	function populateDataTable_GeoChart(dataTable, dataToAdd) {
		  		var countryName;
				for (idx in dataToAdd) {
					row = dataToAdd[idx];
					lastIndex = row.length-1;
					dataTableRow = new Array();
					dataTableRow[0] = row[0];
					dataTableRow[1] = row[lastIndex];
					dataTable.addRow(dataTableRow);
				}
			}
	  
		  	function showVisitorCountStats() {

				var vccLastYear = document.getElementById('view_count_last_year');
				var vccLastYearCount = calculateViewCountLastYear(aggregatedByMonthLastYear);
				vccLastYearCount.count = vccLastYearCount.count.toLocaleString(); // adds thousands separators
				vccLastYear.innerHTML = "Your profile has been viewed " + vccLastYearCount.count + " times since " + vccLastYearCount.start;
				
				var vccThisMonth = document.getElementById("view_count_this_month");
				vccThisMonthCount = calculateViewCountThisMonth(aggregatedByMonthAll);
				vccThisMonthCount = vccThisMonthCount.toLocaleString(); // adds thousands separators
				vccThisMonth.innerHTML = vccThisMonthCount;
			
				var vccBestMonth = document.getElementById("view_count_best_month");
				vccBestMonthCount = calculateViewCountBestMonth(aggregatedByMonthAll);
				vccBestMonthCount = vccBestMonthCount.toLocaleString(); // adds thousands separators
				vccBestMonth.innerHTML = vccBestMonthCount;
			
				var vccAllTime = document.getElementById("view_count_all_time");
				vccAllTimeCount = calculateViewCountAllTime(aggregatedByMonthAll);
				vccAllTimeCount.count = vccAllTimeCount.count.toLocaleString(); // adds thousands separators
				vccAllTime.innerHTML = vccAllTimeCount.count;
			
				var vccAllTimeSince = document.getElementById("view_count_all_time_since");
				vccAllTimeSince.innerHTML = "Since " + vccAllTimeCount.start + "*";
		  	}

		  	function showViewsByCountry(data, onlyShowN) {
		  		var dataToShow, index, item, countryName, countryCode, count;

				// remove any existing rows before adding new ones
		  		$("#geo-list tr").remove();

		  		// add the table headers
		  		$("#geo-list").append("<tr></tr>");
		  		$("#geo-list tr").append("<th>Country</th>");
			    $("#geo-list tr").append("<th></th>");
		  		$("#geo-list tr").append("<th>Views</th>");

		  		// add CSS class to the table headers
		  		$("#geo-list tr th").each(function() {
		  		  $(this).addClass("panel-list-header");
		  		});

			    // add CSS class to the first item in the header
			    $("#geo-list tr th:first-child").each(function () {
			        $(this).addClass("panel-list-image");
			    });

		  		// add CSS classes to the last item in the header
		  		$("#geo-list tr th:last-child").each(function() {
		  		  $(this).addClass("panel-list-count");
		  		});

  				// hide the See Fewer button 
				$("#geo-see-fewer-btn").each(function() {
  					$(this).addClass("visuallyhidden");
  				});

		  		// filter out data that we don't want to display
		  		if (onlyShowN > 0) {
		  			dataToShow = data.slice(0, onlyShowN);
		  			if (data.length > dataToShow.length) {

		  				// unhide the See All button 
						$("#geo-see-all-btn").each(function() {
		  					$(this).removeClass("visuallyhidden");
		  				});
		  			} else {
			  			dataToShow = data;

		  				// hide the See All button 
						$("#geo-see-all-btn").each(function() {
		  					$(this).addClass("visuallyhidden");
		  				});
		  			}
		  		} else {
		  			dataToShow = data;

	  				// hide the See All button 
					$("#geo-see-all-btn").each(function() {
	  					$(this).addClass("visuallyhidden");
	  				});
		  		}

		  		// add table dataToShow rows
		  		for (index in dataToShow) {
		  			item = dataToShow[index];
		  			countryName = item[0];
		  			countryCode = getCountryCode(countryName);
		  			count = item[1];

					//TODO: Fix this path
			  		$("#geo-list").append("<tr><td><img src=http://cranestylelabs.github.io/personal-stats-gadget/images/flag_icons/"+ countryCode + ".gif></img></td><td>" + countryName + "</td><td>" + count + "</td></tr>");
		  		}

		  		// add CSS class to the table rows
		  		$("#geo-list tr").each(function() {
		  		  $(this).addClass("panel-list-row");
		  		});

			    // add CSS class to the first item in each row
			    $("#geo-list tr td:first-child").each(function () {
			        $(this).addClass("panel-list-image");
			    });

		  		// add CSS class to the last item in each row
		  		$("#geo-list tr td:last-child").each(function() {
		  		  $(this).addClass("panel-list-count");
		  		});
		  	}

		  	function showViewsByDomain(data, onlyShowN) {
		  		console.log("show views by domain data:");
		  		console.log(data);
		  		console.log("show views by domain onlyShowN:");
		  		console.log(onlyShowN);

		  		var dataToShow, index, item, domainName, count;

				// remove any existing rows before adding new ones
		  		$("#domain-list tr").remove();

		  		// add the table headers
		  		$("#domain-list").append("<tr></tr>");
		  		$("#domain-list tr").append("<th>Domain</th>");
		  		$("#domain-list tr").append("<th>Views</th>");

		  		// add CSS class to the table headers
		  		$("#domain-list tr th").each(function() {
		  		  $(this).addClass("panel-list-header");
		  		});

		  		// add CSS classes to the last item in the header
		  		$("#domain-list tr th:last-child").each(function() {
		  		  $(this).addClass("panel-list-count");
		  		});

  				// hide the See Fewer button 
				$("#domain-see-fewer-btn").each(function() {
  					$(this).addClass("visuallyhidden");
  				});

		  		// filter out data that we don't want to display
		  		if (onlyShowN > 0) {
		  			dataToShow = data.slice(0, onlyShowN);
		  			if (data.length > dataToShow.length) {

		  				// unhide the See All button 
						$("#domain-see-all-btn").each(function() {
		  					$(this).removeClass("visuallyhidden");
		  				});
		  			} else {
			  			dataToShow = data;

		  				// hide the See All button 
						$("#domain-see-all-btn").each(function() {
		  					$(this).addClass("visuallyhidden");
		  				});
		  			}
		  		} else {
		  			dataToShow = data;

	  				// hide the See All button 
					$("#domain-see-all-btn").each(function() {
	  					$(this).addClass("visuallyhidden");
	  				});
		  		}

		  		console.log("show views by domain dataToShow:");
		  		console.log(dataToShow);


		  		// add table dataToShow rows
		  		for (index in dataToShow) {
		  			item = dataToShow[index];
		  			domainName = item[0];
		  			count = item[1];

			  		$("#domain-list").append("<tr><td>" + domainName + "</td><td>" + count + "</td></tr>");
		  		}

		  		// add CSS class to the table rows
		  		$("#domain-list tr").each(function() {
		  		  $(this).addClass("panel-list-row");
		  		});

		  		// add CSS class to the last item in each row
		  		$("#domain-list tr td:last-child").each(function() {
		  		  $(this).addClass("panel-list-count");
		  		});

			    console.log("domain panel-list-count count = " + $("#domain-list .panel-list-count").length);
		  	}

		  	function getCountryCode(countryName) {
		  		var returnValue = "";
		  		var filteredList = countryCodeList.filter(function(item) { 
		  		    return item.name === countryName;
		  		});
		  		if (filteredList[0]) {
		  			return filteredList[0].code.toLowerCase()
		  		}
		  		return returnValue;
		  	}
			
			function getYearMonthOneYearAgoMonthStart() {
		 		var today = new Date();
			 	var start_date = new Date(today.getFullYear() - 1, today.getMonth(), 1);
			 	var start_date_string = convertDateToYearMonthString(start_date);
				return start_date_string;
			}

			function convertDateToYearMonthString(date) {
			 	var month_numbers = new Array('01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12');
			 	var date_string = date.getFullYear() + month_numbers[date.getMonth()];
			 	return date_string;
			}
		  
		  	function calculateViewCountLastYear(data) {
			  	var i, row, lastIndex;
				
			  	var firstRow = data[0];
	  		  	var lastIndex = firstRow.length-1;
				var count = data.reduce(function(prevVal, elem) {
				    return prevVal + parseInt(elem[lastIndex]);
				}, 0);

	  		  	var start = firstRow[0];
				start = formatMonthYear(start);
				start = start.replace("-", " 20");
				
				var viewCount = {
					count: count,
					start: start
				}
				
				return viewCount;
		  	}
		
			function calculateViewCountThisMonth(data) {
				var lastRowIndex = data.length-1;
				var lastRow = data[lastRowIndex];
				var lastIndex = lastRow.length-1;
				return parseInt(lastRow[lastIndex]);
				//TODO: Need to handle 1st of month where there is no Analytics data yet.
			}
			
			function calculateViewCountBestMonth(data) {
				var i, row, lastIndex;
				var highestCount = 0;
				
				for (i = 0; i < data.length; i++) {
				  	row = data[i];
				  	lastIndex = row.length-1;
					if (parseInt(row[lastIndex]) > highestCount) {
						highestCount = row[lastIndex];
					}
				}
				return parseInt(highestCount);
			}
		
			function calculateViewCountAllTime(data) {
				var i, row, lastIndex, currentRowVal;
				var count = 0;
				var start = "";
				var checkStart = true;
		
				for (i = 0; i < data.length; i++) {
		  		  	row = data[i];
		  		  	lastIndex = row.length-1;
					currentRowVal = parseInt(row[lastIndex]);
					count = count + currentRowVal;
					
					// find the first month with data
					if (checkStart == true) {
						start = row[0];
						if (currentRowVal > 0) {
							checkStart = false;
						}
					}
				}

				// Format for viewing after counting is done
				start = formatMonthYear(start);
				start = start.replace("-", " 20");
				
				var viewCount = {
					count: count,
					start: start
				}
				
				return viewCount;
			}

	      	function aggregateDataByCountry(data, dateStart) {
	      		
				var start = dateStart || 0
	      		var lastIndex = data[0].length-1;

				var dataFilteredByDate = data.filter(function(elem, i, array) {
				        return array.indexOf(elem) === i && elem >= start;
				    }
				);

				var countryArray = dataFilteredByDate.map(function(elem) {
				    return elem[1];
				});

				var filteredCountryArray = countryArray.filter(function(elem, i, array) {
				        return array.indexOf(elem) === i;
				    }
				);

				var arrayToReturn = filteredCountryArray.map(function(country) {
				    var count = dataFilteredByDate.reduce(function(prevVal, elem) {
				        if(elem[1] == country) {
				            return prevVal + parseInt(elem[lastIndex]);
				        } 
				        else {
				            return prevVal;
				        }
				    }, 0);
				    return new Array(country, count); 
				});

				// sort by sessions, descending
				arrayToReturn.sort(function(a,b) {
				    return b[1]-a[1]
				});

				fixCountryNames(arrayToReturn);

				return arrayToReturn;
			}

			function fixCountryNames(arr) {
				var idx, item;
				for (idx in arr) {
					item = arr[idx];
					if(item[0] == "Côte d’Ivoire" || item[0] == "Côte d'Ivoire") {
						item[0] = "Cote d'Ivoire";
					}
				}
			}


	      	function aggregateDataByDomain(data, dateStart) {
	      		console.log(data);
	      		console.log(dateStart);

				var start = dateStart || 0
	      		var lastIndex = data[0].length-1;

				var dataFilteredByDate = data.filter(function(elem, i, array) {
				        return array.indexOf(elem) === i && elem >= start;
				    }
				);
				console.log(dataFilteredByDate);

				var domainArray = dataFilteredByDate.map(function(elem) {
				    return elem[2];
				});

				var filteredDomainArray = domainArray.filter(function(elem, i, array) {
				        return array.indexOf(elem) === i;
				    }
				);

				console.log(filteredDomainArray);

				var arrayToReturn = filteredDomainArray.map(function(domain) {
				    var count = dataFilteredByDate.reduce(function(prevVal, elem) {
				        if(elem[2] == domain) {
				            return prevVal + parseInt(elem[lastIndex]);
				        } 
				        else {
				            return prevVal;
				        }
				    }, 0);
				    return new Array(domain, count); 
				});

				// sort by sessions, descending
				arrayToReturn.sort(function(a,b) {
				    return b[1]-a[1]
				});

				return arrayToReturn;
			}
		
			function init() {

				osapi.jsonld.getOwner().execute(function(owner_data) {
					framePerson(owner_data, function(ownerObj) {
						ownerData = ownerObj;

						//TODO: Fix this path
						$.getJSON("http://cranestylelabs.github.io/personal-stats-gadget/countries.json", function(response){
						    countryCodeList = response;
					  		fetchData();
						});
					});
				});
			}
	
        	gadgets.util.registerOnLoadHandler(init);
	  
		</script>
	]]></Content>
</Module>